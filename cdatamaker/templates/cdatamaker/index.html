<!DOCTYPE html>
<html><head>
  <script>
    function callback(_jsonTxt){
      console.log("_jsonTxt:"+_jsonTxt);
      var outTxtFullEle = document.getElementById("iOutTextFull");
      outTxtFullEle.value = _jsonTxt;
      var jsonObj = JSON.parse(_jsonTxt);
      console.log("callback:"+jsonObj);
      var outTxtEle = document.getElementById("iOutText");
      outTxtEle.value = jsonObj.text.replace(/'^20'/g, '"');

      addAudioArea(jsonObj.path);
    }
    function onClick(){
      console.log("onClick()");
      var req = new XMLHttpRequest();
      req.onreadystatechange = function() {
        var result = document.getElementById("iOutText");
        if (req.readyState == 4) { // 通信の完了時
          if (req.status == 200) { // 通信の成功時
            console.log("200 ok:"+req.responseText);
            callback(req.responseText);
          }
        }else{
          console.log("通信中...");
          result.value = "通信中...";
        }
      }

      var inTextEle = document.getElementById("iInText");
      var text = inTextEle.value.replace(/"/g, '^20');
      if(text==""){
        text="dummy";
      }
      if(text.length>5000){
        text = text.substr(0,5000);
      }
      var inPathEle = document.getElementById("iInPath");
      var path=inPathEle.value;
      console.log("inPathEle.value="+inPathEle.value);
      if(path==""){
        text="output";
      }
      
      let utf8str = String.fromCharCode.apply(null, new TextEncoder().encode(text));
      console.log("req start:"+utf8str);
      req.open('GET', '/api/t2a/?text='+utf8str+'&path='+path, true);
      req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      req.send(Document);        
    }

    function addAudioArea(filename){
      var tgtDivEle = document.getElementById("iAudioOutDiv");
      var audioEle = document.createElement("audio");
      audioEle.preload="metadata";
      audioEle.controls = true;
      var srcEle = document.createElement("source");
      srcEle.src="media/"+filename+".wav";
      srcEle.type="audio/wav";
      var src2Ele = document.createElement("source");
      src2Ele.src="media/"+filename+".mp3";
      src2Ele.type="audio/mp3";
      audioEle.appendChild(srcEle);
      tgtDivEle.appendChild(audioEle);
    }

    function onConvPic(){
      var picEle = document.getElementById("iPic");
      alert(picEle.value);
    }

    function previewFile() {
      const preview = document.querySelector('img');
      const file = document.querySelector('input[type=file]').files[0];
      const reader = new FileReader();

      reader.addEventListener("load", function () {
        // pic to base64
        preview.src = reader.result;
        var inTextEle = document.getElementById("iInText");
        var bs64Arr = reader.result.split(',');
        if(bs64Arr.length>1){
          console.log("bs64Arr[1].length:"+bs64Arr[1].length);
          if(bs64Arr[1].length>5000){
            bs64Arr[1] = bs64Arr[1].substr(0,5000);
          }
          inTextEle.value = bs64Arr[1];
        }else{
          inTextEle.value = bs64Arr[0];
        }
      }, false);

      if (file) {
        reader.readAsDataURL(file);
      }
    }

  </script>
</head><body>
  {% load static %}
  <img src="{% static 'images/lenna_high.png' %}" width="100px" border="0" /><br/>
  <input type="file" onchange="previewFile()"><br>

  <form id = "iForm1" method="post" enctype="multipart/form-data">
    text(<5kB):<br/>
    <textarea  id="iInText" type="text" rows="10" cols="50">
10 cls
20 print "d""hello"
30 goto 20
    </textarea><br/>
    filename:<input id="iInPath" type="text" value="output"/>
    <input type="button" value="send" onclick="onClick()"/>
  </form>
  <form id = "iForm2">
    <input id = "iOutText" type="text" value=""/><br/>
    <input id = "iOutTextFull" type="text" value=""/>
  </form>

  <div id="iAudioOutDiv">
  </div>
    
</body></html>